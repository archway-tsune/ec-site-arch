name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Create release ZIP
        run: |
          zip -r "ec-site-arch-v${{ steps.version.outputs.VERSION }}.zip" . \
            -x "node_modules/*" \
            -x ".next/*" \
            -x "coverage/*" \
            -x "test-results/*" \
            -x "playwright-report/*" \
            -x ".git/*" \
            -x ".claude/*" \
            -x ".specify/memory/*" \
            -x ".specify/scripts/*" \
            -x "scripts/*" \
            -x "specs/*" \
            -x "*.tsbuildinfo" \
            -x "pnpm-lock.yaml" \
            -x "*.zip" \
            -x "playwright.samples.config.ts" \
            -x ".github/workflows/release.yml"

      - name: Create GitHub Release
        run: |
          gh release create "${{ github.ref_name }}" \
            "ec-site-arch-v${{ steps.version.outputs.VERSION }}.zip" \
            --title "${{ github.ref_name }}" \
            --generate-notes
        env:
          GH_TOKEN: ${{ github.token }}
