# 機能仕様書: サンプルテストの集約・再構成

**フィーチャーブランチ**: `004-consolidate-sample-tests`
**作成日**: 2026-02-08
**ステータス**: ドラフト
**入力**: サンプルテストの集約・再構成。テストファイルが2箇所に分散している状態を解消し、src/samples/tests/ に集約。E2Eテストをドメイン毎に分解して本番実装時の参照を容易にする。

## Clarifications

### Session 2026-02-08

- Q: サンプルテスト除外の仕組みをどのレベルで実現するか？ → A: テスト設定の除外パターンで制御（デフォルト除外、CI時のみサンプル含むコマンドを実行）
- Q: サンプル含む専用コマンドの命名規則は？ → A: `:samples` サフィックス（`test:unit:samples`, `test:integration:samples`, `test:e2e:samples`）
- Q: E2Eテストの共有ヘルパー（ログイン・状態リセット）の配置方法は？ → A: 各テストファイルにインラインで含める（ファイルの独立性を優先）

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 単体・統合テストの集約移動 (優先度: P1)

開発者がサンプルの単体テスト・統合テストを一箇所で参照できるようにする。現在各ドメインディレクトリに分散している9ファイルのテストを、集約されたテストディレクトリに移動する。移動後もすべてのテストが正常に実行でき、テスト数に変化がないことを保証する。

**この優先度の理由**: テストの物理的な移動が最も基本的な作業であり、後続のE2E分解（P2）やドキュメント更新（P3）の前提となる。移動だけで「サンプル削除時にrm -rf src/samples/ で完結する」という主要目的の大部分を達成できる。

**独立テスト**: 9ファイルを移動し参照パスを更新した後、既存の単体テスト・統合テストをすべて実行してパスすること、およびテスト数がベースラインと一致することで検証できる。

**受入シナリオ**:

1. **前提** 3ドメインの単体テスト（6ファイル）が各ドメインディレクトリ内に分散している, **操作** 集約テストディレクトリの単体テスト配下にドメイン別で移動する, **結果** 6ファイルが集約ディレクトリに存在し、元の場所には残っていない
2. **前提** 3ドメインの統合テスト（3ファイル）が各ドメインディレクトリ内に分散している, **操作** 集約テストディレクトリの統合テスト配下にドメイン別で移動する, **結果** 3ファイルが集約ディレクトリに存在し、元の場所には残っていない
3. **前提** テストファイルがドメイン実装への相対パスで参照している, **操作** エイリアス参照に変更する, **結果** すべてのテストファイルがエイリアス経由で参照しており、相対パスによるドメイン実装への参照が存在しない
4. **前提** 移動前のテスト実行結果がベースラインとして記録されている, **操作** 移動後にすべてのテストを実行する, **結果** テスト数・テスト結果がベースラインと完全に一致する

---

### ユーザーストーリー 2 - E2Eテストのドメイン別分解 (優先度: P2)

開発者が本番ドメインを実装する際に、該当ドメインのE2Eテストだけを参照・模倣できるようにする。現在ドメイン横断的に記述されている2ファイルのE2Eテストを、ドメイン毎（商品カタログ、カート、注文）に分解して再配置する。

**この優先度の理由**: E2Eテストのドメイン別分解は「本番実装時に参照が容易」という目的の核心部分であり、単純な移動（P1）より設計判断を伴う。P1が完了していなくても独立して実施可能だが、最終的な配置先はP1と整合する必要がある。

**独立テスト**: 分解後のE2Eテストファイルをすべて実行し、分解前と同じテストケース数・同じ検証内容がカバーされていることで検証できる。

**受入シナリオ**:

1. **前提** 購入者導線E2Eテストが1ファイルにまとまっている, **操作** 商品カタログ（一覧・詳細閲覧）、カート（追加・数量変更・空状態）、注文（確定・履歴・一連フロー）にドメイン別に分解する, **結果** 3つのドメインディレクトリにそれぞれ購入者導線テストファイルが存在し、各ファイルが該当ドメインの操作のみをテストしている
2. **前提** 管理者導線E2Eテストが1ファイルにまとまっている, **操作** 商品カタログ（CRUD・ステータス管理）と注文（一覧・詳細・ステータス更新）にドメイン別に分解する, **結果** 2つのドメインディレクトリにそれぞれ管理者導線テストファイルが存在し、各ファイルが該当ドメインの管理操作のみをテストしている
3. **前提** ドメイン横断の一連フローテスト（商品閲覧→カート→注文確定）が存在する, **操作** 注文ドメインの購入者導線テストにまとめる, **結果** 一連フローテストが注文ドメインの購入者導線テスト内に含まれており、商品閲覧・カート操作を前提条件として注文完了までを検証している
4. **前提** 分解前のE2Eテスト実行結果がベースラインとして記録されている, **操作** 分解後のすべてのE2Eテストを実行する, **結果** テストケース数がベースラインと一致し、すべてのテストがパスする

---

### ユーザーストーリー 3 - サンプルテストの環境別実行制御 (優先度: P3)

アーキテクチャリポジトリのCI環境ではサンプルテスト（単体・統合・E2E）がすべて実行され、リリースZIP展開後の本番用開発環境ではサンプルテストがデフォルトで除外されるようにする。テスト設定の除外パターンでサンプルテストをデフォルト除外とし、アーキテクチャリポジトリのCIのみサンプルを含む専用コマンドを実行する方式で制御する。

**この優先度の理由**: サンプルテストの除外制御はP1・P2でテストが集約された後に設定すべきであり、集約によって除外パターンが単純化される（1ディレクトリの除外で完結する）。

**独立テスト**: デフォルトのテスト実行コマンドでサンプルテストが除外されること、およびサンプル含むコマンドでサンプルテストが実行されることで検証できる。

**受入シナリオ**:

1. **前提** テスト設定にサンプル除外パターンが設定されていない, **操作** 単体・統合テスト設定にサンプルテストディレクトリの除外パターンを追加する, **結果** デフォルトのテスト実行コマンドでサンプルテストが検出・実行されない
2. **前提** E2Eテスト設定にサンプル除外パターンが設定されていない, **操作** E2Eテスト設定にサンプルテストディレクトリの除外パターンを追加する, **結果** デフォルトのE2Eテスト実行コマンドでサンプルE2Eテストが検出・実行されない
3. **前提** サンプルテストがデフォルト除外されている, **操作** サンプル含む専用コマンドを実行する, **結果** サンプルテストを含むすべてのテストが実行され、パスする
4. **前提** リリースZIPを展開して本番開発環境を構築した, **操作** デフォルトのテスト実行コマンドを実行する, **結果** サンプルテストが実行されず、本番テストのみが実行される

---

### ユーザーストーリー 4 - 設定・ドキュメントの整合性確保 (優先度: P4)

開発者がプロジェクトドキュメントや設定ファイルを参照した際に、テストの新しい配置構造に基づいた正確な情報を得られるようにする。ドキュメントが実際のディレクトリ構成と一致する。

**この優先度の理由**: ドキュメントの更新はP1・P2・P3の完了後に実施する仕上げ作業であり、コードの動作自体には影響しないが、開発者体験に直結する。

**独立テスト**: ドキュメント内のテストパス記述が実際のディレクトリ構成と一致することで検証できる。

**受入シナリオ**:

1. **前提** サンプルのREADMEが旧テスト構造を記述している, **操作** 新しいテスト構造に合わせて更新する, **結果** READMEのディレクトリツリーが実際の構成と一致し、テストの配置方針が正確に記述されている
2. **前提** プロジェクトのREADMEおよびスクリプト説明が旧テストパスを参照している, **操作** 新しいテストパスに合わせて更新する, **結果** すべてのドキュメントでテストパスの記述が実際のディレクトリ構成と一致している

---

### エッジケース

- テスト間で共有されるヘルパー関数（ログインヘルパー等）が複数ファイルから参照される場合、分解後も正しく共有できるか
- E2Eテストの分解時に、ドメイン横断的なセットアップ処理（テスト状態リセット、ログイン等）が各ドメインファイルで重複しないよう適切に配置されているか
- 分解後の各E2Eテストファイルが単独でも実行可能か（他ドメインのテストに依存しないか）
- サンプル実装を削除した後に、集約テストディレクトリも含めて完全にクリーンアップできるか

## 要件 *(必須)*

### 機能要件

- **FR-001**: 各ドメインディレクトリに分散している単体テスト（6ファイル）が、集約テストディレクトリの単体テスト配下にドメイン別で配置されていること
- **FR-002**: 各ドメインディレクトリに分散している統合テスト（3ファイル）が、集約テストディレクトリの統合テスト配下にドメイン別で配置されていること
- **FR-003**: 移動後のテストファイルがドメイン実装を相対パスではなくエイリアス経由で参照していること
- **FR-004**: 購入者導線E2Eテストがドメイン別（商品カタログ・カート・注文）に分解され、各ドメインディレクトリに配置されていること
- **FR-005**: 管理者導線E2Eテストがドメイン別（商品カタログ・注文）に分解され、各ドメインディレクトリに配置されていること
- **FR-006**: ドメイン横断の一連フローテスト（商品閲覧→カート→注文確定）が注文ドメインの購入者導線テストに含まれていること
- **FR-007**: 分解後の各E2Eテストファイルが他ドメインのテストに依存せず、単独で実行可能であること
- **FR-008**: デフォルトのテスト実行コマンド（単体・統合・E2E）でサンプルテストが除外されること
- **FR-009**: サンプル含む専用コマンド（`test:unit:samples`, `test:integration:samples`, `test:e2e:samples`）でサンプルテストを含むすべてのテストが実行できること
- **FR-010**: 移動・分解後のテスト数が移動・分解前のベースラインと一致すること（サンプル含むコマンドで検証）
- **FR-011**: 旧テストディレクトリ（各ドメイン内のtests/、tests/e2e/arch/）が空になり削除されていること
- **FR-012**: サンプルのREADME、プロジェクトのREADME、スクリプト説明のテストパス記述が実際のディレクトリ構成と一致していること
- **FR-013**: サンプル全体を削除（rm -rf src/samples/）した場合に、サンプル関連のテストファイルが残存しないこと

### 主要エンティティ

- **集約テストディレクトリ**: サンプル実装のすべてのテスト（単体・統合・E2E）を一箇所に集約した構造。本番テストディレクトリと同じ階層構成（テスト種別/ドメイン/）を持つ
- **ドメイン別E2Eテスト**: 従来ドメイン横断的だったE2Eテストを、ドメイン単位に分解したもの。各ファイルが特定ドメインの操作のみを検証し、本番実装時の参照用テンプレートとして機能する
- **テストベースライン**: 移動・分解前のテスト実行結果（テスト数・パス/フェイル状態）。変更の正当性を検証する基準

## 成功基準 *(必須)*

### 計測可能な成果

- **SC-001**: サンプルのテストファイルが集約テストディレクトリの1箇所のみに存在し、他の場所に分散していないこと
- **SC-002**: 移動・分解後のテスト実行で、テスト数がベースラインと100%一致すること
- **SC-003**: すべてのテスト（単体・統合・E2E）が移動・分解後にパスすること
- **SC-004**: E2Eテストがドメイン単位で独立して実行可能であり、各ドメインのテストファイルが他ドメインに依存しないこと
- **SC-005**: サンプル全体を削除した場合にサンプル関連のテストファイルが0件残存すること
- **SC-006**: 開発者がドメイン別E2Eテストを参照して本番E2Eテストを作成する際に、該当ドメインのテストファイル1つを見るだけで必要なパターンを把握できること
- **SC-007**: デフォルトのテスト実行コマンドでサンプルテストが0件検出されること
- **SC-008**: サンプル含む専用コマンドでサンプルテストがすべて検出・実行され、パスすること

## スコープ外

- テストの内容・ロジックの変更（構造的な移動・分解のみ行う）
- 新しいテストケースの追加
- 本番テストディレクトリ（tests/）の構造変更
- サンプルの機能実装（api/、ui/）の変更

## 前提条件

- 003-decouple-samples でサンプル実装の独立化が完了している
- 移動・分解はテストの振る舞いを変更しない内部リファクタリングである
- E2Eテストの分解時に、共有ヘルパー関数（ログイン処理・テスト状態リセット等）は各テストファイルにインラインで含める（ファイルの独立性を優先し、本番テスト作成時にファイル1つをコピーするだけで完結する）
- ドメイン横断の一連フローテストは注文ドメインに帰属するものとして扱う（注文完了が最終ゴールであるため）
