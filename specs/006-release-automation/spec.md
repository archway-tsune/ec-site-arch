# Feature Specification: GitHub リリース自動化

**Feature Branch**: `006-release-automation`
**Created**: 2026-02-08
**Status**: Draft
**Input**: User description: "GitHub Releases を使ったリリース自動化。タグプッシュ(v*)で ZIP 作成・GitHub Release 公開・パッチバージョンインクリメントを行う GitHub Actions ワークフローを追加する。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - コマンド実行によるリリース (Priority: P1)

開発者がリリースコマンド（例: `pnpm release`）を実行すると、`package.json` の現在のバージョンからタグが自動作成・プッシュされ、GitHub Actions がリリース ZIP の作成と GitHub Release の公開を行う。開発者はバージョン番号を手入力する必要がない。

**Why this priority**: リリース自動化の中核機能。タグ番号の手動管理を不要にし、手動作業の削減と配布の一貫性を確保するために最も重要。

**Independent Test**: リリースコマンドを実行した後、GitHub Releases ページにリリースが作成され、バージョン付き ZIP ファイルがダウンロード可能であることを確認する。

**Acceptance Scenarios**:

1. **Given** `package.json` の version が `0.1.0` の状態, **When** 開発者がリリースコマンドを実行する, **Then** `v0.1.0` タグが作成・プッシュされ、GitHub Release が `v0.1.0` タイトルで作成され、`ec-site-arch-v0.1.0.zip` が添付される
2. **Given** タグプッシュによりワークフローが起動した状態, **When** ZIP が作成される, **Then** ZIP の内容は既存のローカルリリーススクリプト（`create-release-zip.ps1`）と同じ除外パターンが適用され、かつリリースワークフロー自体も除外される
3. **Given** タグプッシュによりワークフローが起動した状態, **When** GitHub Release が作成される, **Then** リリースノートが自動生成される
4. **Given** 同じバージョンのタグが既に存在する状態, **When** 開発者がリリースコマンドを実行する, **Then** エラーメッセージが表示され、タグは作成されない

---

### User Story 2 - パッチバージョン自動インクリメント (Priority: P2)

リリース完了後、`package.json` のパッチバージョンが自動的にインクリメントされ、main ブランチにコミットされる。これにより、次のリリースコマンド実行時に新しいバージョンで自動的にタグが作成される。

**Why this priority**: リリース後の手作業を減らし、バージョン番号の一貫性を保つ。ただし P1 なしでは成立しないため P2。

**Independent Test**: リリースコマンド実行後、main ブランチの `package.json` のバージョンがインクリメントされていることを確認する。

**Acceptance Scenarios**:

1. **Given** `v0.1.0` タグでリリースが完了した状態, **When** バージョンインクリメントが実行される, **Then** `package.json` の version が `0.1.1` に更新され、main ブランチにコミットされる
2. **Given** バージョンインクリメントのコミットが作成される状態, **When** main ブランチにプッシュされる, **Then** CI ワークフローが再トリガーされない（無限ループ防止）
3. **Given** バージョンが `0.1.1` にインクリメントされた状態, **When** 開発者が再度リリースコマンドを実行する, **Then** `v0.1.1` タグが自動的に作成される

---

### User Story 3 - ローカルリリーススクリプトとの整合性維持 (Priority: P3)

自動リリースで作成される ZIP の除外パターンと、既存のローカルリリーススクリプト（`pnpm release:zip`）の除外パターンが一致している。ローカルスクリプトも引き続き利用可能である。

**Why this priority**: 既存ワークフローの後方互換性。自動化があっても、ローカルでの手動 ZIP 作成が必要な場面は残る。

**Independent Test**: `pnpm release:zip` を実行し、ZIP が正常に作成されること。ZIP の内容が自動リリースと一致していること。

**Acceptance Scenarios**:

1. **Given** リリース自動化が導入された状態, **When** 開発者がローカルで `pnpm release:zip` を実行する, **Then** ZIP が正常に作成される
2. **Given** ローカルスクリプトと自動ワークフローの両方が存在する状態, **When** 除外パターンを比較する, **Then** 自動ワークフローの除外パターンはローカルスクリプトの除外パターンに加え、リリースワークフローファイル自体も除外する

---

### Edge Cases

- 同じバージョンのタグが既に存在する場合、リリースコマンドがエラーで終了する
- タグ名が `v` で始まらない場合はワークフローがトリガーされない
- バージョンインクリメントのコミット・プッシュ時にコンフリクトが発生した場合、ワークフローはエラー終了する（手動対応が必要）
- `package.json` のバージョン形式がセマンティックバージョニング（x.y.z）でない場合はリリースコマンドが失敗する
- main ブランチ以外でリリースコマンドを実行した場合の動作は未定義（警告を出すことが望ましい）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 開発者がリリースコマンド（例: `pnpm release`）を実行すると、`package.json` の現在のバージョンからタグ（`v{VERSION}`）が自動作成・プッシュされなければならない
- **FR-002**: リリースコマンドは、同じバージョンのタグが既に存在する場合、エラーメッセージを表示して中断しなければならない
- **FR-003**: システムは `v*` パターンのタグプッシュを検知してリリースワークフローを自動実行しなければならない
- **FR-004**: システムはタグ名からバージョン番号を抽出しなければならない（例: `v0.1.1` → `0.1.1`）
- **FR-005**: システムはプロジェクトファイルを ZIP 形式でアーカイブしなければならない。ZIP のファイル名は `ec-site-arch-v{VERSION}.zip` とする
- **FR-006**: ZIP から除外するファイル・ディレクトリは、既存のローカルリリーススクリプト（`create-release-zip.ps1`）の除外パターンと一致させ、さらにリリースワークフローファイル自体を追加で除外しなければならない
- **FR-007**: システムは GitHub Release を作成し、タイトルにバージョン番号を含め、ZIP ファイルを添付しなければならない
- **FR-008**: システムはリリースノートを自動生成しなければならない
- **FR-009**: リリース完了後、システムは `package.json` のパッチバージョンを自動的にインクリメントしなければならない（例: `0.1.0` → `0.1.1`）
- **FR-010**: バージョンインクリメントのコミットは CI を再トリガーしないよう制御しなければならない
- **FR-011**: バージョンインクリメントのコミットは main ブランチにプッシュしなければならない
- **FR-012**: ローカルリリーススクリプト（`create-release-zip.ps1`）の除外パターンにリリースワークフローファイルを追加しなければならない
- **FR-013**: リリース関連のドキュメント（`scripts/README.md`）を更新し、コマンドベースのリリースフローを反映しなければならない

### Key Entities

- **バージョンタグ**: セマンティックバージョニングに基づくタグ（`v{MAJOR}.{MINOR}.{PATCH}`）。リリースワークフローのトリガーとなる
- **リリース ZIP**: プロジェクトの配布用アーカイブ。開発ツールやビルド成果物を除外したプロジェクトファイルの集合
- **GitHub Release**: GitHub 上のリリースエントリ。バージョン情報、リリースノート、ダウンロード可能な ZIP を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 開発者がリリースコマンドを 1 回実行するだけで、タグ作成から GitHub Release の公開まで人手を介さず完了する
- **SC-002**: 自動リリースの ZIP 内容がローカルスクリプトによる ZIP 内容と一致する（リリースワークフローファイルの除外を除く）
- **SC-003**: リリース完了後、`package.json` のパッチバージョンが自動的にインクリメントされている
- **SC-004**: バージョンインクリメントのコミットによって CI が再トリガーされない
- **SC-005**: ローカルリリーススクリプト（`pnpm release:zip`）が引き続き正常に動作する

## Assumptions

- リポジトリは GitHub でホストされており、GitHub Actions が利用可能である
- リリースは main ブランチからのみ行う
- バージョニングはセマンティックバージョニング（MAJOR.MINOR.PATCH）に従う
- タグはリリースコマンドにより `package.json` のバージョンから自動作成される
- リリースノートは GitHub の自動生成機能を使用する（カスタムテンプレートは範囲外）
- CI/CD パイプライン（`ci.yml`）は既に存在し、テスト実行を担当している。リリースワークフローではテストは実行しない

## Scope Boundaries

### In Scope

- リリースコマンド（`pnpm release`）の新規作成（`package.json` のバージョンからタグ自動作成・プッシュ）
- GitHub Actions リリースワークフローの新規作成
- タグプッシュによる ZIP 作成・GitHub Release 公開
- パッチバージョンの自動インクリメント
- 既存ローカルスクリプトの除外パターン更新
- ドキュメント（`scripts/README.md`）の更新

### Out of Scope

- MAJOR / MINOR バージョンの自動インクリメント
- リリースノートのカスタムテンプレート
- CI/CD パイプライン（`ci.yml`）の変更
- NPM パッケージとしての公開
