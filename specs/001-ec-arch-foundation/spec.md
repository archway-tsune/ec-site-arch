# 機能仕様書: ECサイト向けアーキテクチャ基盤

**フィーチャーブランチ**: `001-ec-arch-foundation`
**作成日**: 2026-02-05
**ステータス**: ドラフト
**入力**: ECサイト向けアーキテクチャ基盤 実装仕様

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 開発者が新規ドメインをテンプレートから立ち上げる (優先度: P1)

開発者として、新しいECドメイン（例：Catalog）を実装する際に、UI・API・テストのテンプレートを使って迅速に開発を開始したい。これにより、認証・認可・エラー処理などの共通基盤が自動的に適用され、業務ロジックに集中できる。

**なぜこの優先度か**: テンプレートから新規ドメインを立ち上げられることが本プロジェクトの核心価値であり、これがなければ基盤の意味がない。

**独立テスト**: Catalogドメインをテンプレートから作成し、商品一覧取得のUIとAPIが動作することを確認する。

**受け入れシナリオ**:

1. **Given** UIテンプレートが存在する状態で, **When** 開発者がCatalogドメイン用のUIを作成する, **Then** Server Componentで商品一覧を表示するページが生成される
2. **Given** APIテンプレートが存在する状態で, **When** 開発者がCatalogドメイン用のAPIを作成する, **Then** ユースケース起点の商品取得APIが生成される
3. **Given** テストテンプレートが存在する状態で, **When** 開発者がテストを作成する, **Then** Given-When-Then形式の単体・統合・E2Eテストの雛形が生成される

---

### ユーザーストーリー 2 - 購入者が商品閲覧からカート追加まで完了する (優先度: P2)

購入者として、商品を閲覧してカートに追加し、購入手続きに進みたい。ログイン状態で操作し、セッションが適切に管理され、認可が正しく機能することを期待する。

**なぜこの優先度か**: EC基盤の主要なユーザー導線であり、認証・認可・セッション管理の基盤機能が正しく動作することを検証できる。

**独立テスト**: buyerロールでログインし、商品閲覧→カート追加→カート確認の導線を完了できることを確認する。

**受け入れシナリオ**:

1. **Given** buyerロールでログインした状態で, **When** 商品一覧ページにアクセスする, **Then** 商品一覧が表示される
2. **Given** 商品詳細ページを表示した状態で, **When** カートに追加ボタンを押す, **Then** 商品がカートに追加され、ヘッダーのカート件数が更新される
3. **Given** 未ログイン状態で, **When** カート追加を試みる, **Then** ログインページにリダイレクトされる

---

### ユーザーストーリー 3 - 管理者が商品を管理する (優先度: P3)

管理者として、商品の登録・編集・削除を行いたい。adminロールでのみアクセス可能な管理画面を使い、適切な監査ログが記録されることを期待する。

**なぜこの優先度か**: 管理者機能は購入者導線の後に必要となり、ロールベースの認可機能を検証できる。

**独立テスト**: adminロールでログインし、商品の登録・編集・削除が可能で、buyerロールではアクセスできないことを確認する。

**受け入れシナリオ**:

1. **Given** adminロールでログインした状態で, **When** 管理画面にアクセスする, **Then** 商品管理ダッシュボードが表示される
2. **Given** 管理画面を表示した状態で, **When** 新規商品を登録する, **Then** 商品が保存され、監査ログが記録される
3. **Given** buyerロールでログインした状態で, **When** 管理画面URLに直接アクセスする, **Then** 403エラーが表示される

---

### ユーザーストーリー 4 - 共通レイアウトの一貫した表示 (優先度: P4)

すべてのユーザーとして、どの画面でもヘッダー・フッター・ナビゲーションが一貫して表示され、現在のログイン状態やカート状態が確認でき、アクセシビリティが確保されていることを期待する。

**なぜこの優先度か**: UIの一貫性は重要だが、機能的な導線の後に実装しても価値を提供できる。

**独立テスト**: 複数のページを遷移し、ヘッダー・フッターが一貫して表示され、ロールに応じた導線が表示されることを確認する。

**受け入れシナリオ**:

1. **Given** ログイン済みの状態で, **When** 任意のページにアクセスする, **Then** ヘッダーにログイン状態とカート件数が表示される
2. **Given** adminロールでログインした状態で, **When** ヘッダーを確認する, **Then** 管理者導線のリンクが表示される
3. **Given** buyerロールでログインした状態で, **When** ヘッダーを確認する, **Then** 管理者導線のリンクは表示されない

---

### エッジケース

- セッション有効期限が切れた状態でAPI呼び出しを行った場合、401エラーを返し、クライアントはログインページにリダイレクトする
- 不正なロールでユースケースを実行しようとした場合、403エラーを返し、詳細情報は漏洩させない
- 入力バリデーションエラーが発生した場合、VALIDATION_ERRORコードと具体的なフィールドエラーを返す
- 存在しないリソースにアクセスした場合、NOT_FOUNDエラーを返す
- 同一商品を重複してカートに追加した場合、数量を増加させる（上書きしない）
- 極端に長い入力値が送信された場合、適切にバリデーションエラーを返す

## 要件 *(必須)*

### 機能要件

#### 共通アーキテクチャ基盤

- **FR-001**: システムは、ログイン必須の認証基盤を提供しなければならない
- **FR-002**: システムは、buyer と admin の2つのロールによる認可を提供しなければならない
- **FR-003**: システムは、画面・ルートレベルとユースケース実行レベルの二段階認可を実施しなければならない
- **FR-004**: システムは、userId と role のみを保持するセッション管理を提供しなければならない
- **FR-005**: システムは、CSRF対策を基盤として提供しなければならない
- **FR-006**: システムは、共通形式でエラーを扱い、クライアント向けエラーは安全にマスクしなければならない
- **FR-007**: システムは、個人情報をログに出力してはならない
- **FR-008**: システムは、監査が必要な操作を拡張可能な形でフックできなければならない

#### ドメイン別テンプレート

- **FR-009**: テンプレートは、Server Components基本のUI実装雛形を提供しなければならない
- **FR-010**: テンプレートは、ユースケース起点のAPI実装雛形を提供しなければならない
- **FR-011**: テンプレートは、runtime validationを組み込んだ入力検証機構を提供しなければならない
- **FR-012**: テンプレートは、Given-When-Then形式のテスト実装雛形を提供しなければならない
- **FR-013**: テンプレートは、入出力契約（DTO）の定義パターンを提供しなければならない
- **FR-014**: テンプレートは、認可チェックの組み込みポイントを提供しなければならない

#### UIデザイン基盤

- **FR-015**: 共通画面は、ヘッダー（ナビゲーション、カート導線、ログイン状態、管理者導線）を提供しなければならない
- **FR-016**: 共通画面は、フッター（補助リンク、コピーライト）を提供しなければならない
- **FR-017**: 共通画面は、ローディング・エラー・空状態のステータス表示を提供しなければならない
- **FR-018**: UIは、モバイル・タブレット・PCでレスポンシブに対応しなければならない
- **FR-019**: UIは、キーボード操作・フォーカス表示・色覚多様性のアクセシビリティを確保しなければならない

#### 契約（Contract）

- **FR-020**: すべてのユースケースは、Input/Output型を明示的に定義しなければならない
- **FR-021**: エラーは、UNAUTHORIZED/FORBIDDEN/VALIDATION_ERROR/NOT_FOUND/CONFLICT/INTERNAL_ERRORのコード体系に従わなければならない
- **FR-022**: 各ユースケースは、必要なロールを明示しなければならない

#### テスト

- **FR-023**: 単体テストは、外部依存を持たない形でドメインロジックとユースケースを検証しなければならない
- **FR-024**: 統合テストは、API契約が守られていることを検証しなければならない
- **FR-025**: E2Eテストは、購入者導線（商品閲覧→カート→購入完了）を検証しなければならない
- **FR-026**: E2Eテストは、管理者導線（商品管理→注文確認）を検証しなければならない

### 主要エンティティ

- **User**: ユーザーを表す。userId、role（buyer/admin）を持つ。セッションと関連付けられる
- **Session**: セッションを表す。userId、role、有効期限を持つ。CSRFトークンと関連付けられる
- **Product**: 商品を表す。商品名、価格、説明、画像を持つ。Catalogドメインに属する
- **CartItem**: カート内商品を表す。商品参照、数量を持つ。Cartドメインに属する
- **Order**: 注文を表す。購入者、商品リスト、合計金額、ステータスを持つ。Ordersドメインに属する
- **AuditLog**: 監査ログを表す。操作種別、実行者、タイムスタンプ、操作対象を持つ

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 開発者が新規ドメインのUI・API・テストをテンプレートから30分以内に立ち上げられる
- **SC-002**: 購入者導線（商品閲覧→カート→購入完了）を3分以内に完了できる
- **SC-003**: 認可エラー発生時、ユーザーは1秒以内に適切なエラーメッセージを受け取る
- **SC-004**: テストカバレッジ80%以上を維持する
- **SC-005**: すべてのE2Eテストがパスする
- **SC-006**: アクセシビリティ検証ツールで重大なエラーが0件である
- **SC-007**: モバイル・タブレット・PCの3デバイスで主要導線が正常に動作する
- **SC-008**: セッション失効後のAPI呼び出しが100%正しく401エラーを返す

## 前提条件

- セッション方式を採用（JWT等のトークン方式ではない）
- ログイン必須を前提とし、匿名ユーザー機能は対象外
- 対象ドメインは初期5ドメイン（Catalog, Cart, Checkout, Orders, Admin）
- UIフレームワークはServer Components対応のもの（Next.js等）を想定
- テストフレームワークは一般的なJavaScript/TypeScriptテストツールを想定
