<!--
Sync Impact Report
==================
Version change: 1.0.0 → 1.1.0
Modified principles: N/A（既存原則の変更なし）
Added sections:
  - 品質基準とゲート/E2E テスト証跡義務
  - 品質基準とゲート/ローカルカバレッジ確認
  - 品質基準とゲート/外部リソース URL 検証
  - 品質基準とゲート/サンプルコード保護原則
Removed sections: N/A
Templates requiring updates:
  - .specify/templates/plan-template.md: ✅ 整合性確認済み（Constitution Check セクション対応）
  - .specify/templates/spec-template.md: ✅ 整合性確認済み（ユーザーストーリー・要件形式対応）
  - .specify/templates/tasks-template.md: ✅ 整合性確認済み（OPTIONAL→MANDATORY 修正、Red-Green-Refactor-検証 4ステップ構成、テスト4種別明記）
Follow-up TODOs: なし
-->

# ECサイト向けアーキテクチャ基盤 Constitution

本プロジェクトは、ECサイトを効率的かつ安全に開発するための共通アーキテクチャ基盤と、
ドメインごとのUI・API・テスト実装テンプレートを提供する。
特定のECサイトを完成させることを目的とせず、複数のECプロジェクトで再利用可能な「開発基盤」を提供する。

## Core Principles

### I. コンポーネントファースト設計

UIはコンポーネント単位で設計・実装する。

- 共通コンポーネントおよび共通画面を優先利用する
- Server Components を基本とし、Client Components は最小限に抑える
- 表示ロジックと業務ロジックを分離する
- 未認証・認可失敗時の挙動を統一する

### II. ドメイン駆動設計

ドメイン単位で UI・API・テストを一体として設計・実装する。

- 対象ドメイン: Catalog, Cart, Checkout, Orders, Admin
- 各ドメインは UI 実装の雛形、API 実装の雛形、テスト実装の雛形を持つ
- 入出力契約（DTO）をドメインごとに定義する
- 認可チェックの組み込みポイントをテンプレートとして提供する
- 業務固有のビジネスルール、データ永続層の実装詳細、個別UIカスタマイズは提供しない

### III. サーバーサイド中心のデータ制御

画面（UI）とサービス（API）の責務を明確に分離し、サーバーサイドでデータ制御を行う。

- ユースケース起点で処理を構成する
- 入力は必ず runtime validation を行う
- 認可は必ずユースケース実行前にサーバーサイドで検証する
- レスポンス形式およびエラーコード体系を統一する

### IV. 型安全必須

型安全な開発を必須とする。

- すべての入出力に型定義を適用する
- TypeScript strict mode を有効にする
- 型推論に頼らず、明示的な型定義を優先する
- any 型の使用を禁止する（やむを得ない場合は unknown を使用）

### V. セキュリティ最優先

セキュリティを設計・実装の最優先事項とする。

- ログイン必須を前提とする
- 最小ロール構成（buyer, admin）を標準とする
- 認可は画面遷移レベルと業務実行レベルの二重防御を行う
- セッション方式を標準とし、セッションに保持する情報は最小限とする
- セッション失効・再生成を考慮し、CSRF対策を基盤として提供する
- クライアントに返すエラーは安全にマスクする
- 個人情報をログに出力しない

### VI. テスト駆動開発（TDD）必須（非交渉）

テスト駆動開発を必須とする。テストを書かない実装は許可しない。

- Red-Green-Refactor-検証 サイクルを厳格に遵守する
- Red フェーズで以下の 4 種別のテストを作成する
  - ユースケース単体テスト（ドメインロジック）
  - UI コンポーネント単体テスト（表示・インタラクション）
  - API 統合テスト（入力バリデーション・認可・レスポンス）
  - E2E テスト（ユーザー導線の主要フロー）
- テストテンプレートは UI/API テンプレートと同格の成果物とする
- 新ドメイン追加時は、必ずテストテンプレートを利用する
- Given-When-Then を基本構造とし、正常系・異常系・認可条件を必ず含める

## 共通アーキテクチャ基盤

### 認証・認可

| 項目 | 要件 |
|------|------|
| 認証方式 | ログイン必須 |
| ロール構成 | buyer, admin（最小構成） |
| 認可判定 | サーバーサイドで最終判定 |
| 防御レイヤー | 画面遷移レベル + 業務実行レベル |

### セッション管理

| 項目 | 要件 |
|------|------|
| 方式 | セッション方式を標準 |
| 保持情報 | 最小限 |
| 失効処理 | セッション失効・再生成を考慮 |
| CSRF対策 | 基盤として提供 |

### エラー・ログ・監査

| 項目 | 要件 |
|------|------|
| エラー形式 | 共通形式で統一 |
| クライアント返却 | 安全にマスク |
| ログ出力 | 個人情報を出力しない |
| 監査フック | 基盤でフック可能 |

## ドメイン別テンプレート

### テンプレートが提供するもの

- UI 実装の雛形（Server Components 基本）
- API 実装の雛形（ユースケース起点）
- テスト実装の雛形（単体・統合・E2E）
- 入出力契約（DTO）
- 認可チェックの組み込みポイント
- テスト駆動開発を前提とした構造

### テスト種別

| 種別 | 対象 | 要件 |
|------|------|------|
| 単体テスト | ドメインロジック・ユースケース | 外部依存なし、Given-When-Then、正常系・異常系・認可条件 |
| 統合テスト | API とユースケースの結合 | 入力バリデーション、認可、エラー処理、API契約検証 |
| E2Eテスト | ユーザー導線 | 購入者導線（商品閲覧→カート→購入完了）、管理者導線（商品管理→注文確認） |

## 品質基準とゲート

| 基準 | 要件 |
|------|------|
| 開発手法 | テスト駆動開発（TDD）必須 |
| テストカバレッジ | 80%以上を維持 |
| CI | 自動テスト必須 |
| 品質ゲート | 通過しない成果物は統合しない |

### E2E テスト証跡義務

- E2E テスト実行結果の出力を確認し、パス件数 0 件の場合はエラーとする
- 「テストを実行した」と報告するだけでは不十分。実行結果の出力（パス/失敗件数）を証跡として提示すること
- 実装のみで E2E テストの実行をスキップすることは禁止する

### ローカルカバレッジ確認

- 各ユーザーストーリー完了時に `pnpm test:unit --coverage` を実施し、カバレッジ 80% 以上を確認する
- CI での失敗を待たず、ローカルで事前に検証する
- カバレッジが不足する場合は、不足テストを追加してからストーリーを完了とする

### 外部リソース URL 検証

- 実装時に各 URL に HTTP リクエスト（WebFetch 等）を送信し、200 応答を確認する
- 失敗した URL は代替 URL に置換する
- plan 時点では「検証予定」とし、「検証済み」としない（LLM が生成した URL は実在しない可能性がある）

### サンプルコード保護原則

- contracts の新規フィールドは `.default()` または `.optional()` を付与する（必須フィールド追加はサンプルテストを破損させるため禁止）
- シードデータはベース（サンプル互換・不変）と拡張（本番追加分）に分離する
- リポジトリインターフェースの検索パラメータ追加はオプショナルとする

## Governance

### 改訂手続き

1. 憲章の変更提案は文書化し、変更理由を明記する
2. 変更は影響を受けるテンプレートの更新を伴う
3. バージョン番号は Semantic Versioning に従う
   - MAJOR: 原則の削除または根本的な再定義
   - MINOR: 新しい原則・セクションの追加または大幅な拡張
   - PATCH: 明確化、文言修正、誤字修正

### 遵守確認

- すべての PR/レビューは本憲章への準拠を確認する
- 複雑さの追加は正当化が必要（Complexity Tracking で記録）
- ドキュメントは日本語で記述する

### 参照ファイル

- テンプレート: `.specify/templates/` 配下
- 仕様書・計画・タスク: `specs/[feature]/` 配下

**Version**: 1.1.0 | **Ratified**: 2026-02-05 | **Last Amended**: 2026-02-11
